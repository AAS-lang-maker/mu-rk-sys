<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>榜单页</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #1E293B;
            min-height: 100vh;
            position: relative;
            color: #f7fafc;
        }

        .container {
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 60px;
        }

        .header h1 {
            font-size: 36px;
            color: #fffa9c;
            margin-bottom: 20px;
        }

        .header p {
            font-size: 18px;
            color: rgba(247, 250, 252, 0.7);
        }

        .content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 100px;
        }

        .content h2 {
            font-size: 24px;
            color: #fffa9c;
            margin-bottom: 30px;
        }

        .content p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .add-button-container {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }

        .add-button {
            width: 80px;
            height: 80px;
            background-color: #fffa9c;
            color: #1a202c;
            border: none;
            border-radius: 50%;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(255, 250, 205, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 250, 205, 0.6);
        }

        .add-button:active {
            transform: scale(0.95);
        }

        .rankings-list {
            margin-bottom: 30px;
        }

        .ranking-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .ranking-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(10px);
            border-left-color: #fffa9c;
        }

        .ranking-item h3 {
            color: #fffa9c;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .ranking-item p {
            color: rgba(247, 250, 252, 0.7);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .ranking-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: rgba(255, 250, 156, 0.8);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 40px;
        }

        .pagination button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 250, 156, 0.3);
            color: #f7fafc;
            border-radius: 6px;
            padding: 8px 16px;
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background-color: #fffa9c;
            color: #1a202c;
            transform: translateY(-2px);
        }

        .pagination button.active {
            background-color: #fffa9c;
            color: #1a202c;
            font-weight: bold;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 歌曲列表样式 */
        .song-list {
            margin-top: 15px;
            padding-left: 0;
        }

        .song-list h4 {
            color: #fffa9c;
            font-size: 16px;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .song-list ul {
            list-style: none;
            padding: 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            padding: 10px;
        }

        .song-list li {
            margin: 8px 0;
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255, 250, 156, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .song-list li:last-child {
            border-bottom: none;
        }

        .song-list li:hover {
            background: rgba(255, 250, 156, 0.05);
        }

        .song-name {
            color: #f7fafc;
            font-size: 15px;
            flex: 1;
        }

        .song-rank {
            color: #fffa9c;
            font-size: 15px;
            font-weight: 600;
            margin-left: 20px;
            padding: 4px 10px;
            background: rgba(255, 250, 156, 0.1);
            border-radius: 4px;
        }

        /* 互动按钮样式 */
        .interaction-section {
            margin-top: 15px;
            padding-left: 15px;
            display: flex;
            gap: 15px;
        }

        .vote-btn,
        .collect-btn {
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 15px;
            border-radius: 20px;
        }

        .vote-btn:hover {
            background: rgba(255, 182, 193, 0.2);
        }

        .collect-btn:hover {
            background: rgba(192, 192, 192, 0.2);
        }

        .heart-icon {
            color: #ffb6c1;
            font-size: 18px;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .vote-btn:hover .heart-icon {
            color: #ff69b4;
            transform: scale(1.1);
        }

        .vote-btn.voted .heart-icon {
            color: #ff69b4;
        }

        .star-icon {
            color: #e68181;
            font-size: 18px;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .collect-btn:hover .star-icon {
            color: #ffffff;
            transform: scale(1.1);
        }

        .collect-btn.collected .star-icon {
            color: #ffffff;
        }

        .vote-count,
        .collect-count {
            font-size: 14px;
            font-weight: bold;
        }

        .vote-count {
            color: rgba(255, 182, 193, 0.9);
        }

        .collect-count {
            color: rgba(192, 192, 192, 0.9);
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 28px;
            }

            .content {
                padding: 30px;
            }

            .add-button {
                width: 70px;
                height: 70px;
                font-size: 36px;
            }
        }
    </style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>音乐排行榜</h1>
        <p>探索热门音乐和艺术家</p>
    </div>

    <div class="content">
        <h2>榜单列表</h2>

        <!-- 动态榜单列表 -->
        <div class="rankings-list">
            <div th:each="ranking, stat : ${rankings.list}" class="ranking-item">
                <h3 th:text="${ranking.rankName}">榜单标题</h3>
                <p th:text="${ranking.description}">榜单描述</p>
                <p class="ranking-meta">
                    <span th:text="|创建者: ${ranking.creatorName}|">创建者</span>
                    <span th:text="|更新时间: ${ranking.updateTime}|">更新时间</span>
                </p>

                <!-- 歌曲列表 -->
                <div class="song-list">
                    <h4>歌曲列表</h4>
                    <ul>
                        <li th:each="song : ${ranking.rankSongList}">
                            <span class="song-name" th:text="${song.songName}">歌曲名称</span>
                            <span class="song-rank" th:text="${song.ranking}">排名</span>
                        </li>
                    </ul>

                    <!-- 投票和收藏按钮 -->
                    <div class="interaction-section">
                        <button class="vote-btn" th:onclick="|voteForRanking(${publishRanks.rankId})|">
                            <span class="heart-icon">❤</span>
                            <span class="vote-count" th:text="${publishRanks.voteCount}">0</span>
                        </button>
                        <button class="collect-btn" th:onclick="|collectRanking(${publishRanks.rankId})|">
                            <span class="star-icon">★</span>
                            <span class="collect-count" th:text="${publishRanks.collectCount}">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分页组件 -->
        <div class="pagination">
            <button th:disabled="${rankings.pageNum == 1}"
                    th:onclick="|goToPage(${rankings.pageNum - 1})|">上一页</button>
            <button th:each="i : ${#numbers.sequence(1, rankings.pages)}"
                    th:class="${rankings.pageNum == i ? 'active' : ''}" th:onclick="|goToPage(${i})|"
                    th:text="${i}">1</button>
            <button th:disabled="${rankings.pageNum == rankings.pages}"
                    th:onclick="|goToPage(${rankings.pageNum + 1})|">下一页</button>
        </div>
    </div>
</div>
<div class="add-button-container">
    <button class="add-button" id="addBtn">+</button>
</div>
<!-- 可伸缩的"我的榜单"按钮（放在页面右侧） -->
<div class="slide-btn-container">
    <button class="slide-btn-toggle expanded" id="slideBtnToggle">
        <span class="toggle-icon">我的榜单</span>
    </button>
    <button class="slide-btn-content show" id="myRankBtn">进入我的榜单</button>
</div>

<style>
    .slide-btn-container {
        position: fixed;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        z-index: 999;
        display: flex;
        align-items: center;
    }

    .slide-btn-toggle {
        width: 120px;
        height: 50px;
        border-radius: 25px 0 0 25px;
        background: #fffa9c;
        color: #1a202c;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        font-size: 16px;
        font-weight: bold;
        box-shadow: -2px 0 10px rgba(255, 250, 156, 0.3);
    }

    .slide-btn-toggle:hover {
        background: #fff780;
        box-shadow: -2px 0 15px rgba(255, 250, 156, 0.5);
    }

    .slide-btn-toggle.collapsed {
        width: 50px;
        background: rgba(255, 250, 156, 0.8);
    }

    .slide-btn-toggle.collapsed .toggle-icon {
        display: none;
    }

    .toggle-icon {
        display: inline;
        font-size: 14px;
        margin-left: 5px;
    }

    .slide-btn-content {
        height: 50px;
        padding: 0 20px;
        background: #fffa9c;
        color: #1a202c;
        border: none;
        cursor: pointer;
        border-radius: 4px 0 0 4px;
        margin-right: -1px;
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s;
        font-size: 14px;
        font-weight: bold;
    }

    .slide-btn-content.show {
        transform: translateX(0);
        opacity: 1;
    }

    .slide-btn-content:hover {
        background: #fff780;
    }
</style>
</body>
<script>
    function getUrlParam(paramName) {
        const reg = new RegExp("(^|&)" + paramName + "=([^&]*)(&|$)");
        const paramMatch = window.location.search.substr(1).match(reg);
        return paramMatch ? decodeURIComponent(paramMatch[2]) : null;
    }

    // 修复2：确保showErrorTip的DOM存在（如果没有，加一个）
    function showErrorTip(msg) {
        // 如果页面没有errorAlert，动态创建一个
        let el = document.getElementById('errorAlert');
        if (!el) {
            el = document.createElement('div');
            el.id = 'errorAlert';
            el.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:10px 20px;background:#ff4444;color:#fff;border-radius:4px;z-index:9999;';
            document.body.appendChild(el);
        }
        el.innerText = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 2000);
    }

    // 修复3：按钮交互+跳转逻辑
    const slideBtnToggle = document.getElementById('slideBtnToggle');
    const myRankBtn = document.getElementById('myRankBtn');
    let isExpanded = true;

    // 展开/收起按钮
    slideBtnToggle.onclick = function () {
        isExpanded = !isExpanded;
        if (isExpanded) {
            slideBtnToggle.classList.remove('collapsed');
            slideBtnToggle.classList.add('expanded');
            myRankBtn.classList.add('show');
        } else {
            slideBtnToggle.classList.remove('expanded');
            slideBtnToggle.classList.add('collapsed');
            myRankBtn.classList.remove('show');
        }
    };

    // 点击“进入我的榜单”跳转（加控制台日志，方便排查）
    myRankBtn.onclick = function () {
        const token = getUrlParam("token");
        const userId = getUrlParam("userId"); // 关键修改：和URL的userId保持一致
        console.log("当前token：", token);
        console.log("当前userId：", userId); // 打印日志也同步修改

        // 参数校验（同步修改为userId）
        if (!token || !userId || isNaN(userId)) {
            showErrorTip("缺少登录信息，请重新登录！");
            setTimeout(() => window.location.href = "/music/login.html", 1500);
            return;
        }

        // 跳转URL（同步传递userId，和后端保持一致）
        const jumpUrl = `/music/api/mine/my?token=${encodeURIComponent(token)}&userId=${userId}`;
        console.log("跳转URL：", jumpUrl);
        window.location.href = jumpUrl;
    };
    // ************************** 新增1：通用URL参数获取工具函数（核心，所有页面复用） **************************
    // 作用：从页面URL中解析出token、userId、categoryId等参数（如：publish.html?token=xxx&userId=1&categoryId=1）
    // 通用URL参数获取工具函数
    // 你的getUrlParam函数应该是这样的（如果不是，改成下面的标准写法）：
    function getUrlParam(paramName) {
        const reg = new RegExp("(^|&)" + paramName + "=([^&]*)(&|$)");
        const paramMatch = window.location.search.substr(1).match(reg);
        return paramMatch ? decodeURIComponent(paramMatch[2]) : null;
    }


    // 自定义提示方法
    function showErrorTip(msg) {
        const el = document.getElementById('errorAlert');
        el.innerText = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }
    function showSuccessTip(msg) {
        const el = document.getElementById('successAlert');
        el.innerText = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 2000);
    }

    // 全局变量
    let token = '';
    let userId = '';
    let categoryId = '';

    // 页面加载核心逻辑
    window.onload = function () {
        // 解析参数
        token = getUrlParam("token");
        userId = getUrlParam("userId");
        categoryId = getUrlParam("categoryId");

        // 类型转换+空值校验
        userId = userId ? Number(userId) : null;
        categoryId = categoryId ? Number(categoryId) : null;

        // 登录态校验
        if (!token || token.trim() === '' || !userId || isNaN(userId)) {
            showErrorTip("登录信息失效，请重新登录！");
            setTimeout(() => window.location.href = "/music/login.html", 1500);
            return;
        }
        // 分类ID校验
        if (!categoryId || isNaN(categoryId)) {
            showErrorTip("未获取到有效榜单分类，请重新选择！");
            setTimeout(() => window.location.href = "/music/index.html", 1500);
            return;
        }

        // 调试日志
        console.log("认证参数校验通过：", { token, userId, categoryId });
        showSuccessTip("页面加载成功，可发布榜单啦！");
    };

    // 加号按钮点击事件
    document.getElementById("addBtn").onclick = function () {
        if (!token || !userId || !categoryId || isNaN(userId) || isNaN(categoryId)) {
            showErrorTip("参数缺失，请刷新页面重试！");
            return;
        }
        // 编码参数+拼接/music前缀
        const jumpUrl = `/music/rank.html?token=${encodeURIComponent(token)}&userId=${userId}&categoryId=${categoryId}`;
        window.location.href = jumpUrl;
    };

    // 分页导航函数
    function goToPage(page) {
        window.location.href = `/music/api/mine/my?page=${page}&token=${encodeURIComponent(token)}&userId=${userId}&categoryId=${categoryId}`;
    }

    // 投票函数
    function voteForRanking(rankId) {
        if (!token || !userId || isNaN(userId)) {
            showErrorTip("请先登录后再投票！");
            return;
        }

        // 构建投票请求
        const voteUrl = `/music/api/rank/vote?token=${encodeURIComponent(token)}&userId=${userId}&rankId=${rankId}`;

        fetch(voteUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('投票失败');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showSuccessTip("投票成功！");
                    // 更新投票数显示
                    const voteBtn = document.querySelector(`[onclick*="voteForRanking(${rankId})"]`);
                    if (voteBtn) {
                        const voteCount = voteBtn.querySelector('.vote-count');
                        if (voteCount) {
                            const currentCount = parseInt(voteCount.textContent);
                            voteCount.textContent = currentCount + 1;
                            voteBtn.classList.add('voted');
                        }
                    }
                } else {
                    showErrorTip(data.message || "投票失败，请重试");
                }
            })
            .catch(error => {
                console.error("投票请求异常：", error);
                showErrorTip("网络错误，请稍后重试");
            });
    }

    // 收藏函数
    function collectRanking(rankId) {
        if (!token || !userId || isNaN(userId)) {
            showErrorTip("请先登录后再收藏！");
            return;
        }

        // 构建收藏请求
        const collectUrl = `/music/api/rank/collect?token=${encodeURIComponent(token)}&userId=${userId}&rankId=${rankId}`;

        fetch(collectUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('收藏失败');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showSuccessTip("收藏成功！");
                    // 更新收藏数显示
                    const collectBtn = document.querySelector(`[onclick*="collectRanking(${rankId})"]`);
                    if (collectBtn) {
                        const collectCount = collectBtn.querySelector('.collect-count');
                        if (collectCount) {
                            const currentCount = parseInt(collectCount.textContent);
                            collectCount.textContent = currentCount + 1;
                            collectBtn.classList.add('collected');
                        }
                    }
                } else {
                    showErrorTip(data.message || "收藏失败，请重试");
                }
            })
            .catch(error => {
                console.error("收藏请求异常：", error);
                showErrorTip("网络错误，请稍后重试");
            });
    }

    // 预留接口请求基础逻辑
    function requestApi(apiUrl, method = "GET", data = {}) {
        let fullUrl = `/music${apiUrl}?token=${encodeURIComponent(token)}&userId=${userId}&categoryId=${categoryId}`;
        const requestOptions = {
            method: method,
            headers: {
                "Content-Type": "application/json;charset=utf-8"
            }
        };
        if (method === "POST") {
            requestOptions.body = JSON.stringify(data);
        }
        return fetch(fullUrl, requestOptions)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`接口请求失败：${response.status}`);
                }
                return response.json();
            })
            .catch(error => {
                console.error("接口请求异常：", error);
                showErrorTip("接口请求失败，请检查后端服务或登录信息！");
                throw error;
            });
    }
</script>
</body>

</html>